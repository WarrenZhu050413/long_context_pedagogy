# Async MCP Server for Claude Code

A rate-limited, queue-based MCP (Model Context Protocol) server that processes async queries using Claude Code CLI with subscription authentication (no API keys required).

## Overview

This server enables asynchronous processing of Claude queries with:
- **Rate limiting** to control API usage
- **Queue management** with estimated wait times
- **Persistent results** organized by date
- **No API key required** - uses Claude Code CLI subscription

## Architecture

```
Claude Desktop → MCP Server → Rate Limiter → Task Queue → Claude CLI → ~/async/
                     ↓              ↓             ↓
                Status API    Config API    Results Index
```

## Key Components

### 1. **Rate Limiter** (`rate_limiter.py`)
- Elegant implementation using `asyncio.Semaphore`
- Priority queue for fair task scheduling
- Always accepts tasks (queues instead of rejecting)
- Provides accurate wait time estimates

### 2. **Claude CLI Processor** (`claude_cli_processor.py`)
- Executes `claude --model [model] -p "[prompt]"` via subprocess
- Saves results to `~/async/YYYY-MM-DD/`
- Maintains searchable index at `~/async/index.json`
- Applies concise response personality (200-500 words)

### 3. **MCP Server** (`mcp_async_server.py`)
- Implements MCP protocol for Claude Desktop integration
- Provides three tools:
  - `async_submit(query, model)` - Submit task
  - `async_status(task_id)` - Check status
  - `async_rate_config(max_requests, window_minutes)` - Update limits

## Installation

### Prerequisites
- Python 3.11+
- Claude Code CLI (`npm install -g @anthropic-ai/claude-cli`)
- Claude Code subscription (logged in via `claude login`)
- Docker (optional, for containerized deployment)

### Setup

1. **Clone the repository**
   ```bash
   cd AsyncMCPTest
   ```

2. **Install dependencies** (if running locally)
   ```bash
   pip install mcp asyncio dataclasses
   ```

3. **Verify Claude CLI**
   ```bash
   claude --version
   claude --model sonnet -p "Say hello"
   ```

## Usage

### Local Testing

1. **Test rate limiter**
   ```bash
   PYTHONPATH=server python3 test_rate_limit.py
   ```

2. **Test Claude CLI integration**
   ```bash
   PYTHONPATH=server python3 test_cli_simple.py
   ```

3. **Run integration test**
   ```bash
   PYTHONPATH=server python3 test_integration.py
   ```

### Docker Deployment

1. **Build container**
   ```bash
   docker-compose build
   ```

2. **Start server**
   ```bash
   docker-compose up -d
   ```

3. **Configure Claude Desktop**
   Add to `~/.claude/settings.json`:
   ```json
   {
     "mcpServers": {
       "async-processor": {
         "command": "docker",
         "args": ["exec", "-i", "async-mcp", "python", "/app/mcp_async_server.py"]
       }
     }
   }
   ```

### Using MCP Tools in Claude

Once configured, use these commands in Claude:

```python
# Submit a task
async_submit("What is Docker?", "sonnet")
# Returns: task_id, queue_position, estimated_wait_seconds

# Check status
async_status("task-id-here")
# Returns: status, model, timestamps

# Update rate limits
async_rate_config(max_requests=5, window_minutes=10)
# Returns: updated configuration
```

## Configuration

### Default Settings
- **Max Requests**: 10 per window
- **Window**: 60 minutes
- **Models**: sonnet (default), opus

### Environment Variables
```bash
MAX_REQUESTS=10        # Maximum concurrent requests
WINDOW_MINUTES=60      # Time window for rate limiting
```

### Customization

Edit `server/claude_cli_processor.py` to modify:
- System prompt for response style
- Results directory location
- Model mappings

## How It Works

### 1. Task Submission
When you call `async_submit()`:
1. Task is added to priority queue
2. Rate limiter checks available slots
3. Returns task ID and estimated wait time
4. Task queued if rate limit reached

### 2. Processing
The server continuously:
1. Checks for available rate limit slots
2. Pulls next task from queue
3. Executes `claude -p` command
4. Saves result to `~/async/YYYY-MM-DD/task-id.md`
5. Updates index file
6. Releases slot after time window

### 3. Rate Limiting
- Uses `asyncio.Semaphore` for slot management
- Sliding window algorithm
- Tasks never rejected, only queued
- Accurate wait time calculation

## Results Structure

```
~/async/
├── index.json                    # Searchable task index
├── 2025-08-13/
│   ├── task-001.md              # Task result
│   ├── task-002.md
│   └── ...
└── monitoring/
    └── metrics.json             # Performance metrics
```

### Result File Format
```markdown
# Async Query Result

**Task ID**: task-001
**Model**: sonnet
**Date**: 2025-08-13T19:30:00

## Query
Original query text

## Response
Claude's response here

---
*Generated by Async MCP Server using Claude CLI*
```

## Testing

### Test Files
- `test_rate_limit.py` - Verify rate limiting logic
- `test_cli_simple.py` - Test Claude CLI execution
- `test_no_api_key.py` - Confirm subscription auth works
- `test_integration.py` - Full end-to-end test

### Expected Behavior
With 2 requests/minute limit:
- Tasks 1-2: Process immediately
- Task 3: Queue with 30s wait
- Task 4: Queue with 60s wait
- Etc.

## Troubleshooting

### Claude CLI Issues
```bash
# Check if logged in
claude --version

# Login if needed
claude login

# Test manually
claude --model sonnet -p "Test message"
```

### Docker Issues
```bash
# Check logs
docker logs async-mcp

# Restart container
docker-compose restart

# Rebuild if needed
docker-compose build --no-cache
```

### Rate Limit Issues
- Check `~/async/index.json` for task history
- Verify time windows in configuration
- Monitor queue size in logs

## Key Features

### ✅ No API Key Required
Uses Claude Code CLI subscription authentication

### ✅ Smart Rate Limiting
- Never rejects tasks
- Accurate wait time estimates
- Fair queue ordering

### ✅ Persistent Results
- Organized by date
- Searchable index
- Markdown format

### ✅ Model Flexibility
- Supports sonnet and opus
- Easy to add new models

### ✅ Production Ready
- Docker support
- Error handling
- Logging

## Architecture Decisions

### Why Claude CLI over API?
1. **No API key management** - Uses existing subscription
2. **Built-in auth** - Leverages Claude Code login
3. **Simpler deployment** - No secrets to manage
4. **Cost effective** - Uses subscription, not pay-per-token

### Why Queue Instead of Reject?
1. **Better UX** - Tasks always accepted
2. **Predictable** - Know when task will run
3. **No lost work** - Everything eventually processes
4. **Fair ordering** - FIFO queue ensures fairness

### Why MCP Protocol?
1. **Native integration** - Works directly with Claude Desktop
2. **Standard protocol** - Industry adoption growing
3. **Bidirectional** - Can return status updates
4. **Extensible** - Easy to add new tools

## Future Enhancements

- [ ] Priority levels for urgent tasks
- [ ] Batch processing for related queries
- [ ] Result caching for duplicate queries
- [ ] Web UI for monitoring queue
- [ ] Webhook notifications on completion
- [ ] Multiple queue strategies (LIFO, priority)

## Contributing

Feel free to submit issues or pull requests for:
- Additional models support
- Alternative queue strategies
- Performance optimizations
- Better error handling

## License

MIT - Use freely for personal or commercial projects

## Support

For issues:
1. Check troubleshooting section
2. Review test files for examples
3. Check Docker logs if using container
4. Verify Claude CLI is working

---

Built with ❤️ for async Claude processing without API keys